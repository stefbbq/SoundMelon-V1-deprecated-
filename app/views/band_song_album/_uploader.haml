= javascript_include_tag "swfobject.js", "jquery.uploadify.v2.1.0.js"
- session_key = Rails.application.config.session_options[:key]
:javascript
  var song_counter = 1;
  $(document).ready(function() {	   
    $('#song_song').click(function(event){
        event.preventDefault();
      });
      $('#song_song').uploadify({
        uploader : '/uploadify/uploadify.swf',
        cancelImg : '/uploadify/cancel.png',
        multi : true,
        auto : true,
        script : '/band_song_album/create',
        onComplete : function(event, queueID, fileObj, response, data) {
          var dat = eval('(' + response + ')');
         $('#uploaded_images').append(song_counter +">" + dat.upload+'<br />');
         $('#album_name').val(dat.album_name);
         $('#album_name').attr("disabled", true);
         song_counter++;         
         if($('#musicbox .collection #song_album_'+ dat.song_album_id).length ==0){
          var new_album_html = get_list_album_html(dat.song_album_id, dat.album_name, dat.add_url, dat.album_url, dat.image_src);
          $('#musicbox .collection').append(new_album_html);
        }
      },
      onSelect : function(event,data) {
        $("#song_song").uploadifySettings('scriptData', { 'album_name' : $('#album_name').val(), 'band_name' : $('#band_name').val() });
      },
      scriptData : {
        '_http_accept': 'application/javascript',
        'format' : 'json',
        '_method': 'post',
        '#{session_key}' : encodeURIComponent('#{u cookies[session_key]}'),
        'authenticity_token': encodeURIComponent($('meta[name=csrf-token]').attr('content'))  }
      });
      $('#upload_submit').click(function(event){
        event.preventDefault();
        $('#song_song').uploadifyUpload();
      });
  });
  function get_list_album_html(id, album_name, add_url, album_url, img_src){
    var html_str = "<div class='song-album' id='song_album_" + id + "'>";
    html_str      += "<a href='" + add_url + "' class='ajaxopen' data-remote='true'><img alt='Add' src='/assets/add.png'/></a>";
    html_str      += "<span class='album-cover-image'><a href='" + album_url + "' class='ajaxopen' data-remote='true'><img alt='' src='" + img_src + "'/></a></span>";
    html_str      += "<a href='" + album_url + "' class='ajaxopen' data-remote='true'>" + album_name + "</a>";    
    html_str      +="</div>"
    return html_str;
  }