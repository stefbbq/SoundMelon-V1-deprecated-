
- band            = post.band_id.blank? ? nil : post.band
- user            = post.user_id.blank? ? nil : post.user
- post_item       = post.postitem
- unless post_item.blank?
  - buzz_content  = capture do
    - if post.band_album_post?    
      = link_to image_tag('buzz-icon.png'), band_album_buzz_path(post_item.id, :album_name => post_item.name), :remote => true, :class => 'ajaxopen'
    - elsif post.band_tour_post?      
      = link_to image_tag('buzz-icon.png'), band_tour_buzz_path(post_item.band.name, post_item.id), :remote => true, :class => 'ajaxopen'
    - elsif post.song_post?
      = link_to image_tag('buzz-icon.png'), song_buzz_path(post_item), :remote => true, :class => 'ajaxopen'
    - elsif post.song_album_post?      
      = link_to image_tag('buzz-icon.png'), album_buzz_path(post_item.album_name, post_item.id), :remote => true, :class => 'ajaxopen'
- else
  - buzz_content    = ""

- is_author_artist_profile  = (@band && band ) && @band == band
- is_author_fan_profile     = (@user && user ) && @user == user
- self_post                 = is_author_artist_profile || is_author_fan_profile
- hide_thread_link          ||= false
- divclass                  ||=''

- if @band && @is_admin_of_band
  - self_owner = post.band_id == @band.id
- else
  - self_owner = post.user == current_user
- item_div_class = self_owner ? 'content' : 'content-mentioned'

- writer_header = capture do
  - if band
    = is_author_artist_profile ? band.name : (link_to band.name, show_band_path(:band_name =>band.name), :class =>'ajaxopen backable', :remote =>:true)
  - elsif self_owner
    You
  -elsif user
    = is_author_fan_profile ? user.fname : (link_to user.fname, fan_profile_path(post.user), :class =>'ajaxopen backable', :remote =>:true)

- content_header = capture do
  - if post.is_bulletin
    has pinned this to their profile
  - elsif post_item
    - if post.song_post?
      wrote about
      %b #{post_item.title}
      's song
    - elsif post.song_album_post?
      wrote about 
      %b #{post_item.album_name}
      's song album
    - elsif post.band_album_post?
      wrote about
      %b #{post_item.name}
      's photo album
    - elsif post.band_tour_post?
      - post_band     = post_item.band
      - band_name     = post_band ? post_band.name : ''
      wrote about 
      %b #{band_name}
      's show
  - else
    wrote this
  #{time_ago_in_words(post.created_at)} ago

- action_section  = capture do
  - unless buzz_content.blank?
    #{buzz_content}
  - if self_owner
    = link_to user_post_path(post), :method=> :delete, :class=>'action-delete', :remote=>true do
      %i
      %span delete
  - if @band && !self_owner
    = link_to new_post_reply_path(post, :band_id => @band.id), :class=>'action-reply ajaxopen', :remote=>true do
      %i
      %span reply
  - elsif !self_owner    
    = link_to new_post_reply_path(post), :class=>'action-reply ajaxopen', :remote=>true do
      %i
      %span reply

= div_for post do
  %div{:class=>"#{divclass}"}
    .avatar
      - if user
        - if is_author_fan_profile
          = get_avatar_small(user)
        - else
          = link_to get_avatar_small(user), (self_owner ? fan_home_url : fan_profile_path(user) ), :class =>'ajaxopen backable', :remote =>:true
      - elsif band
        - if is_author_artist_profile
          = get_band_logo_small(band)
        - else
          = link_to get_band_logo_small(band), show_band_path(:band_name =>band.name), :class =>'ajaxopen backable', :remote =>:true
    %div{:class => 'content'}
      .post-header
        .title
          %strong
            #{writer_header}            
          %span
            #{content_header}          
        .actions
          #{action_section}
      .post-body
        = post_msg_with_band_mention(post)
    .clear
    - if post.ancestry && !hide_thread_link
      = link_to 'expand conversation', get_post_threads_path(post), :remote => true, :class => 'ajaxload thread-expand toggle-thread', :id =>"expand_link_#{post.id}"